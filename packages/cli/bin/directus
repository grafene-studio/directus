#!/usr/bin/env node

require('dotenv').config();

const amp = require('app-module-path');

amp.addPath(`${__dirname}/../node_modules`);
amp.addPath(`${process.cwd()}/node_modules`);
amp.addPath(process.cwd());

const devMode = require('fs').existsSync(`${__dirname}/../src`);
const wantsCompiled = process.argv.indexOf('--compiled-build') >= 0;
const fs = require('fs');

async function main(run, ts = false) {
	const debug = require('debug')('directus-cli');
	try {
		const { error, output } = await run(process.argv, ts);
		if (error) {
			debug(error);
		}

		if (output) {
			await output.flush(process.stdout);
			process.stdout.write('\n');
		}

		process.exit(error ? 1 : 0);
	} catch (error) {
		console.error(error);
		process.exit(1);
	}
}

let ts = false;
let run = () => {};
if (wantsCompiled || !devMode) {
	if (fs.existsSync('./tsconfig.json') && fs.existsSync('./node_modules/ts-node')) {
		require('ts-node').register({ project: `./tsconfig.json` });
		ts = true;
	}
	run = require(`${__dirname}/../dist/index`).default;
} else {
	ts = true;
	process.env.DEBUG = `${process.env.DEBUG ?? ''}directus-cli`;
	require('ts-node').register({ project: `${__dirname}/../tsconfig.json` });
	run = require(`${__dirname}/../src/index`).default;
}

main(run, ts);
